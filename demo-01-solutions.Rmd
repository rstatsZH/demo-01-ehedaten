---
title: "Ehedaten Kanton Zürich 16. bis 18. Jahrhundert"
output: 
  html_document: 
    toc: yes
    highlight: monochrome
    theme: flatly
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}

library(dplyr)
library(readr)
library(ggplot2)
library(lubridate)

```

# Ziel der Demo 

Das Ziel dieser Demonstration ist es:

- das Importieren und Transformieren von Daten anhand eines typischen realen Beispiels zu zeigen
- neue Funktionen für das Arbeiten mit Datums- und Zeitangaben vorzustellen

# Daten

Ein Datensatz vom Staatsarchiv des Kantons Zürich mit Ehedaten im aus dem 16. bis 18. Jahrhundert. Abgedeckt wird der Zeitraum vom 1. Januar 1500 bis 31. Dezember 1800. 

Metadaten sind auf [opendata.swiss publiziert](https://opendata.swiss/de/dataset/ehedaten-kanton-zurich-16-bis-18-jahrhundert) und die Ressource verlinkt auf das Archiv Zenodo. 

# Daten importieren

```{r}

# download_link <- "https://zenodo.org/record/3964315/files/EDB_16_18_Jh_St# and_2020_07_22.CSV?download=1"
# 
# ehedaten <- read_delim(download_link, delim = ";",
#                        locale = locale(encoding = "ISO-8859-1")) 
# 
# write_csv(ehedaten, "data/ehedaten.csv")

ehedaten <- read_csv("data/ehedaten.csv")

```

# Daten transformieren

```{r}

ehedaten_tidy <- ehedaten %>% 
  janitor::clean_names() %>% 
  select(nachname_mann:kirchgemeinde) %>% 
  ## Teil 1 Ende: Schreibe Zusammenfassungen
  
  ## Teil 2 Start
  mutate(datum = lubridate::ymd(entstehungszeitraum)) %>% 
  filter(!is.na(datum)) %>% 
  ## Teil 2 Ende: Mache ein Histogram
  
  ## Teil 3 Start 
  mutate(datum2 = parse_date(entstehungszeitraum, format = "%Y.%m.%d")) %>% 
  mutate(
    jahr = year(datum),
    monat = month(datum, label = TRUE),
    tag = day(datum),
    wochentag = wday(datum, label = TRUE, week_start = 1)
  )

```

# Daten erkunden

- Was sind die häufigsten 10 Nachnamen der Männer?
- Was sind die häufigsten 10 Nachnamen der Frauen?
- Wieviele Männer und Frauen haben vor der Heirat den gleichen Nachnamen? Und wieviele davon die gleiche Herkunft?
- Was sind die Top 10 Kirchengemeinden in denen geheiratet wurde? Was ist das in Prozent?

```{r}

ehedaten_tidy %>% 
  count(nachname_mann) %>% 
  arrange(desc(n))

ehedaten_tidy %>% 
  count(nachname_frau) %>% 
  arrange(desc(n))

ehedaten_tidy %>% 
  filter(nachname_mann == nachname_frau)  %>% 
  filter(herkunft_mann == herkunft_frau)

ehedaten_tidy %>% 
  count(kirchgemeinde) %>% 
  arrange(desc(n)) %>% 
  mutate(prozent = n / sum(n) * 100)

vektor_top10_kirchgemeinde <- ehedaten_tidy %>% 
  count(kirchgemeinde) %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  pull(kirchgemeinde)


ehedaten_tidy_top10 <- ehedaten_tidy %>% 
  filter(kirchgemeinde %in% vektor_top10_kirchgemeinde)


```


# Daten Transformieren

Aber das war es eigentlich auch schon fast mit dem was wir zur Verfügung haben. Aber was ist mit Fragen wie:

- Wieviele Ehen wurden pro Jahr, Monat, oder Wochentag geschlossen?
- Wie sieht die Entwicklung aus?
- Was für Visualisierungen können wir machen?

Dazu brauchen wir zusätzliche Variablen, wie zum Beispiel:

- Jahr
- Monat 
- Tag 
- und Wochentag?

Aber wie kommen wir an diese?

# Daten Visualisieren

```{r}

ehedaten_tidy %>% 
  count(jahr) 

ehedaten_tidy %>% 
  ggplot(aes(x = datum2)) +
  geom_histogram(bins = 277) +
  scale_x_date(breaks = "100 years") +
  coord_flip()

ehedaten_tidy %>% 
  ggplot(aes(x = monat)) +
  geom_bar()

ehedaten_tidy %>% 
  count(monat) %>% 
  ggplot(aes(x = monat, y = n)) +
  geom_point()

# Wir sehen hier jetzt einen Punkt für jeden Tag im jeweiligen Monat
# Wir können diese mit geom_path verbinden. Doch nun sind die Punkte innerhalb des Monats miteinander verbunden.
# Um die Punkte der einzelnen Tage miteinander zu verbinden, müssen wir den visuellen Eigenschaften ein zusätzliches Argument "group" geben, um die Gruppe der zu verbindenden Daten zu definieren.

# Solch ein Plot/Diagram wird auch als "connected scatterplot" oder "verbundenes Streudiagramm" bezeichnet

ehedaten_tidy %>% 
  count(monat, tag) %>% 
  ggplot(aes(x = tag, y = n, group = monat, color = monat)) +
  geom_point() +
  geom_path()  +
  facet_wrap(~monat)

```


